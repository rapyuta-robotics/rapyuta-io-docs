[[core-components-devices]]
= ROS publisher-subscriber
:toc: macro
:toc-title:
:data-uri:
:experimental:
:prewrap!:
:description:
:keywords:

toc::[]

This tutorial will show you how to deploy a basic ROS package with a ROS publisher running in the cloud and a ROS subscriber running on a Raspberry Pi. 
The ROS publisher sits in a public git repository and is built into a docker container on the fly using `ros-indigo-catkin` build recipe.
The ROS subscriber is assumed to be downloaded on Raspberry Pi and is launched when the package is deployed using rapyuta.io console UI or the
link:../rapyuta_io_sdk/sdk_docs.html[rapyuta.io SDK].

== Prerequisites
To complete this tutorial, you should have the following:

* Raspberry Pi 3.
* Micro SD card of at least 4 Gb.
* Internet connection for your Raspberry Pi (preferably over Ethernet).

== Preparing the Raspberry Pi 3
We are going to use Ubuntu 16.04 on the Raspberry Pi. It is not officially supported, but there is an image available that we will use for this tutorial.

1. Download the image `ubuntu-16.04-preinstalled-server-armhf+raspi3.img.xz` from link:https://ubuntu-pi-flavour-maker.org/download/[here] or 
link:https://wiki.ubuntu.com/ARM/RaspberryPi[here].
2. To make the SD card flashing easier, download and install link:https://etcher.io/[Etcher].
3. Mount the micro SD card on your computer and flash it using Etcher.

image::ros_pub_sub/etcher.png["Flashing the SD card with Etcher"]

[start=4]
4. Insert the micro SD card on the Raspberry Pi micro SD card slot and power it.
5. Connect the Ethernet port of the Raspberry Pi to a router that provides internet access (as the WiFI is not very stable with this setup). To
know the assigned IP, you can connect a display and keyboard. We use `nmap` to know what is the device IP:

    nmap -sn 1.2.3.0/24 // replace 1.2.3 for your local IP address.

5. To make sure that everything is OK so far, try to ssh into the Raspberry Pi. Default user and password are `ubuntu`. You will be required
to change the password as soon as you log in.

    ssh ubuntu@<device IP>

If everything is OK, you should see something like:

image::ros_pub_sub/ssh.png["SSH session started on the Raspberry Pi"]

[start=6]
6. Some more configuration is required to avoid problems in the future. Open with root permissions the file `/etc/default/locale` and add the following line:

    LC_ALL=C

6. Install ROS on the Raspberry Pi following the link:http://wiki.ros.org/kinetic/Installation/Ubuntu[official instructions]. We recommend installing
*ROS-Base*.
7. In the `/etc/hosts` file of the Raspberry Pi, add the following line:

    127.0.1.1 ubuntu 

8. Try running `roscore` on the Raspberry Pi. You should see something like this:

image::ros_pub_sub/roscore.png["ROS running on the Raspberry Pi"]

== Setting the Raspberry Pi as rapyuta.io devices
So far, we have set the minimum requirements for the Raspberry Pi. Now, it is time to integrate them into rapyuta.io.

1. Follow link:../../getting_started/creating_users_groups.html[these instructions] to create a user if you do not have one yet. It is not
necessary to create a group.
2. To add your devices to rapyuta.io, follow link:../../getting_started/adding_new_device.html[these instructions]. Note that you have to run the
device setup link with root permissions.


= OLD

== Creating the package

TODO - Instert image
image::ros_pub_sub/create_pkg.png["Creating the package"]

== Deploying the package
There are two possible ways of deplying the package: using the rapyuta.io console UI or the link:../rapyuta_io_sdk/sdk_docs.html[rapyuta.io SDK].

=== Deploy the package from the rapyuta.io console UI
The instructions to follow are the same as shown in the link:../../getting_started/deploying_package.html[package deployment page]. The only difference
is that you should select different devides for the talker and listener components.

image::ros_pub_sub/deploy_1.png["Available devices"]
image::ros_pub_sub/deploy_2.png["Assign components to devices"]

=== Deploy the package from the link:../rapyuta_io_sdk/sdk_docs.html[rapyuta.io SDK]
[source,python]
from rapyuta_io import Client
client = Client()
package_id = 'my_package_id'    # change with package_id you want to deploy
plan_id = 'my_plan_id'          # change with the plan_id you want to deploy
auth_token = 'my_auth_token'    # change with your auth_token
pkg = client.get_package(package_id=package_id, plan_id=plan_id, auth_token=auth_token)
deployment = pkg.provision(deployment_id=deployment_id)
deployment_info = pkg.get_deployment_info(deployment['deployment_id'])

=== Adding a ROSBridge to this deployment
If you want to add a ROSBridge from the service catalog to your application, you can do so by creating a new deployment of the ROSBridge package from the
service catalog and adding the *DeploymentID* of your previous section in the dependent deployments section of the package creation step. The lifecycle
of the entire deployment (ROSBridge + publisher + subscriber) through the new Deployment.
